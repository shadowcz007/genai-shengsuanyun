<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>genai-shengsuanyun æµ‹è¯•ç¤ºä¾‹</title>
        <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        select {
            cursor: pointer;
        }

        select option {
            padding: 8px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .output {
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            min-height: 100px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .output.success {
            border-color: #4caf50;
            background: #f1f8f4;
        }

        .output.error {
            border-color: #f44336;
            background: #ffebee;
            color: #c62828;
        }

        .output.loading {
            border-color: #ff9800;
            background: #fff3e0;
            color: #e65100;
        }

        .models-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .model-item {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }

        .status.success {
            background: #4caf50;
            color: white;
        }

        .status.error {
            background: #f44336;
            color: white;
        }

        .status.loading {
            background: #ff9800;
            color: white;
        }
    </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸš€ genai-shengsuanyun æµ‹è¯•ç¤ºä¾‹</h1>
            <p class="subtitle">æµ‹è¯• ExtendedGoogleGenAI çš„åŠŸèƒ½</p>

            <!-- API Key é…ç½® -->
            <div class="section">
                <h2>1. é…ç½® API Key</h2>
                <div class="input-group">
                    <label for="apiKey">API Key:</label>
                    <input type="text" id="apiKey"
                        placeholder="è¯·è¾“å…¥æ‚¨çš„ API Key" />
                </div>
                <button onclick="saveApiKey()">ä¿å­˜ API Key</button>
                <span id="apiKeyStatus"></span>
            </div>

            <!-- è·å–æ”¯æŒçš„æ¨¡å‹ -->
            <div class="section">
                <h2>2. è·å–æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨</h2>
                <p style="color: #666; margin-bottom: 15px;">è·å–æ‰€æœ‰é¢„å®šä¹‰çš„æ¨¡å‹åˆ—è¡¨</p>
                <button onclick="getSupportedModels()">è·å–æ”¯æŒçš„æ¨¡å‹</button>
                <div id="modelsOutput" class="output"
                    style="display: none;"></div>
            </div>

            <!-- æŸ¥è¯¢é…é¢ -->
            <div class="section">
                <h2>3. æŸ¥è¯¢é…é¢ä¿¡æ¯</h2>
                <p style="color: #666; margin-bottom: 15px;">æŸ¥è¯¢ API é…é¢å’Œè´¦å•ä¿¡æ¯</p>
                <button onclick="getQuota()">æŸ¥è¯¢é…é¢</button>
                <div id="quotaOutput" class="output"
                    style="display: none;"></div>
            </div>

            <!-- ç”Ÿæˆå†…å®¹æµ‹è¯• -->
            <div class="section">
                <h2>4. ç”Ÿæˆå†…å®¹æµ‹è¯•</h2>
                <div class="input-group">
                    <label for="prompt">æç¤ºè¯:</label>
                    <input type="text" id="prompt"
                        placeholder="è¯·è¾“å…¥æç¤ºè¯ï¼Œä¾‹å¦‚ï¼šä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±" value="ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±" />
                </div>
                <div class="input-group">
                    <label for="model">æ¨¡å‹:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="modelSelect"
                            style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; background: white;">
                            <option value>-- é€‰æ‹©æ¨¡å‹æˆ–è‡ªå®šä¹‰è¾“å…¥ --</option>
                            <option value="custom">[è‡ªå®šä¹‰è¾“å…¥]</option>
                        </select>
                        <input type="text" id="model" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤æ¨¡å‹"
                            style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; display: none;" />
                    </div>
                    <small
                        style="color: #666; margin-top: 5px; display: block;">ä»æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨ä¸­é€‰æ‹©ï¼Œæˆ–é€‰æ‹©"è‡ªå®šä¹‰è¾“å…¥"æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°</small>
                </div>
                <button onclick="generateContent()">ç”Ÿæˆå†…å®¹</button>
                <div id="generateOutput" class="output"
                    style="display: none;"></div>
            </div>

            <!-- æµå¼å“åº”æµ‹è¯• -->
            <div class="section">
                <h2>5. æµå¼å“åº”æµ‹è¯•ï¼ˆæ¨èï¼‰</h2>
                <p style="color: #666; margin-bottom: 15px;">ä½¿ç”¨æµå¼å“åº”å®æ—¶è·å–ç”Ÿæˆå†…å®¹</p>
                <div class="input-group">
                    <label for="streamPrompt">æç¤ºè¯:</label>
                    <input type="text" id="streamPrompt"
                        placeholder="è¯·è¾“å…¥æç¤ºè¯ï¼Œä¾‹å¦‚ï¼šè§£é‡Šé‡å­è®¡ç®—çš„åŸºæœ¬åŸç†" value="è§£é‡Šé‡å­è®¡ç®—çš„åŸºæœ¬åŸç†" />
                </div>
                <div class="input-group">
                    <label for="streamModel">æ¨¡å‹:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="streamModelSelect"
                            style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; background: white;">
                            <option value>-- é€‰æ‹©æ¨¡å‹æˆ–è‡ªå®šä¹‰è¾“å…¥ --</option>
                            <option value="custom">[è‡ªå®šä¹‰è¾“å…¥]</option>
                        </select>
                        <input type="text" id="streamModel" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤æ¨¡å‹"
                            style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; display: none;" />
                    </div>
                    <small
                        style="color: #666; margin-top: 5px; display: block;">ä»æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨ä¸­é€‰æ‹©ï¼Œæˆ–é€‰æ‹©"è‡ªå®šä¹‰è¾“å…¥"æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°</small>
                </div>
                <button onclick="generateContentStream()">å¼€å§‹æµå¼ç”Ÿæˆ</button>
                <div id="streamOutput" class="output"
                    style="display: none;"></div>
            </div>

            <!-- å‡½æ•°è°ƒç”¨æµ‹è¯• -->
            <div class="section">
                <h2>6. å‡½æ•°è°ƒç”¨æµ‹è¯•</h2>
                <p style="color: #666; margin-bottom: 15px;">æµ‹è¯• AI æ¨¡å‹çš„å‡½æ•°è°ƒç”¨åŠŸèƒ½</p>
                <div class="input-group">
                    <label for="functionCallPrompt">æç¤ºè¯:</label>
                    <input type="text" id="functionCallPrompt"
                        placeholder="è¯·è¾“å…¥æç¤ºè¯ï¼Œä¾‹å¦‚ï¼šæŠŠç¯è°ƒæš—ä¸€ç‚¹ï¼Œè®©æˆ¿é—´æ„Ÿè§‰æ¸©é¦¨åˆæ¸©æš–" value="æŠŠç¯è°ƒæš—ä¸€ç‚¹ï¼Œè®©æˆ¿é—´æ„Ÿè§‰æ¸©é¦¨åˆæ¸©æš–" />
                </div>
                <div class="input-group">
                    <label for="functionCallModel">æ¨¡å‹:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="functionCallModelSelect"
                            style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; background: white;">
                            <option value>-- é€‰æ‹©æ¨¡å‹æˆ–è‡ªå®šä¹‰è¾“å…¥ --</option>
                            <option value="custom">[è‡ªå®šä¹‰è¾“å…¥]</option>
                        </select>
                        <input type="text" id="functionCallModel" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤æ¨¡å‹"
                            style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; display: none;" />
                    </div>
                    <small
                        style="color: #666; margin-top: 5px; display: block;">ä»æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨ä¸­é€‰æ‹©ï¼Œæˆ–é€‰æ‹©"è‡ªå®šä¹‰è¾“å…¥"æ‰‹åŠ¨è¾“å…¥æ¨¡å‹åç§°</small>
                </div>
                <button onclick="testFunctionCalling()">æµ‹è¯•å‡½æ•°è°ƒç”¨</button>
                <div id="functionCallOutput" class="output"
                    style="display: none;"></div>
            </div>

            <!-- æµ‹è¯• BaseURL -->
            <div class="section">
                <h2>7. éªŒè¯ BaseURL</h2>
                <p style="color: #666; margin-bottom: 15px;">éªŒè¯é»˜è®¤ baseURL
                    æ˜¯å¦æ­£ç¡®è®¾ç½®ä¸º shengsuanyun è·¯ç”±</p>
                <button onclick="checkBaseUrl()">æ£€æŸ¥ BaseURL</button>
                <div id="baseUrlOutput" class="output"
                    style="display: none;"></div>
            </div>
        </div>

        <script type="importmap">
    {
        "imports": {
            "@google/genai": "./node_modules/@google/genai/dist/web/index.mjs",
            "@google/genai/web": "./node_modules/@google/genai/dist/web/index.mjs"
        }
    }
    </script>

        <script type="module">
        import { ExtendedGoogleGenAI, FunctionCallingConfigMode  } from './dist/web/index.js';
        
        let ai = null;

        // ä¿å­˜ API Key çš„æ ¸å¿ƒå‡½æ•°
        function saveApiKeyCore() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showStatus('apiKeyStatus', 'è¯·è¾“å…¥ API Key', 'error');
                return;
            }

            try {
                ai = new ExtendedGoogleGenAI({
                    apiKey: apiKey
                });
                showStatus('apiKeyStatus', 'âœ“ API Key å·²ä¿å­˜', 'success');
                console.log('ExtendedGoogleGenAI åˆå§‹åŒ–æˆåŠŸ');
                
                // API Key ä¿å­˜æˆåŠŸåï¼Œæ›´æ–°æ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨
                updateModelSelect();
            } catch (error) {
                showStatus('apiKeyStatus', 'âœ— åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
                console.error('åˆå§‹åŒ–é”™è¯¯:', error);
            }
        }

        // æŒ‚è½½åˆ° window ä»¥ä¾¿ onclick å¯ä»¥è®¿é—®ï¼Œå¹¶ä¿å­˜åˆ° localStorage
        window.saveApiKey = function() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (apiKey) {
                localStorage.setItem('genai_api_key', apiKey);
            }
            saveApiKeyCore();
        };

        // è·å–æ”¯æŒçš„æ¨¡å‹ - æŒ‚è½½åˆ° window
        window.getSupportedModels = async function() {
            if (!ai) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }

            const output = document.getElementById('modelsOutput');
            output.style.display = 'block';
            output.className = 'output loading';
            output.textContent = 'æ­£åœ¨è·å–æ”¯æŒçš„æ¨¡å‹...';

            try {
                const models = ai.getSupportedModels();
                output.className = 'output success';
                output.innerHTML = `
<strong>æ”¯æŒçš„æ¨¡å‹åˆ—è¡¨ (å…± ${models.length} ä¸ª):</strong>

${models.map((model, index) => `${index + 1}. ${model}`).join('\n')}
                `.trim();
                console.log('æ”¯æŒçš„æ¨¡å‹:', models);
                
                // æ›´æ–°ç”Ÿæˆå†…å®¹æµ‹è¯•éƒ¨åˆ†çš„æ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨
                updateModelSelect();
            } catch (error) {
                output.className = 'output error';
                output.textContent = 'é”™è¯¯: ' + error.message;
                console.error('è·å–æ¨¡å‹åˆ—è¡¨é”™è¯¯:', error);
            }
        };

        // æŸ¥è¯¢é…é¢ - æŒ‚è½½åˆ° window
        window.getQuota = async function() {
            if (!ai) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }

            const output = document.getElementById('quotaOutput');
            output.style.display = 'block';
            output.className = 'output loading';
            output.textContent = 'æ­£åœ¨æŸ¥è¯¢é…é¢ä¿¡æ¯...';

            try {
                const quotaInfo = await ai.quota.getQuota();
                output.className = 'output success';
                output.textContent = JSON.stringify(quotaInfo, null, 2);
                console.log('é…é¢ä¿¡æ¯:', quotaInfo);
            } catch (error) {
                output.className = 'output error';
                output.textContent = 'é”™è¯¯: ' + error.message + '\n\n' + error.stack;
                console.error('æŸ¥è¯¢é…é¢é”™è¯¯:', error);
            }
        };

        // ç”Ÿæˆå†…å®¹ - æŒ‚è½½åˆ° window
        window.generateContent = async function() {
            if (!ai) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }

            const prompt = document.getElementById('prompt').value.trim();
            const modelSelect = document.getElementById('modelSelect');
            const modelInput = document.getElementById('model');
            
            // è·å–é€‰ä¸­çš„æ¨¡å‹åç§°
            let modelName = '';
            if (modelSelect.value === 'custom') {
                // è‡ªå®šä¹‰è¾“å…¥æ¨¡å¼
                modelName = modelInput.value.trim();
            } else if (modelSelect.value) {
                // ä»ä¸‹æ‹‰åˆ—è¡¨é€‰æ‹©
                modelName = modelSelect.value;
            } else {
                // å¦‚æœä¸‹æ‹‰åˆ—è¡¨ä¸ºç©ºï¼Œæ£€æŸ¥è‡ªå®šä¹‰è¾“å…¥æ¡†
                modelName = modelInput.value.trim();
            }

            if (!prompt) {
                alert('è¯·è¾“å…¥æç¤ºè¯');
                return;
            }

            const output = document.getElementById('generateOutput');
            output.style.display = 'block';
            output.className = 'output loading';
            output.textContent = 'æ­£åœ¨ç”Ÿæˆå†…å®¹...';

            try {
                // å¦‚æœæ²¡æœ‰é€‰æ‹©æ¨¡å‹ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å‹
                const finalModelName = modelName || 'google/gemini-2.5-flash';
               
                const response = await ai.models.generateContent({
                    model:finalModelName,
                    contents:prompt,
                  });
                console.log(response.text);
 
                const text = response.text;
                output.className = 'output success';
                output.textContent = `ä½¿ç”¨çš„æ¨¡å‹: ${finalModelName}\n\nç”Ÿæˆçš„å†…å®¹:\n${text}`;
                console.log('ç”Ÿæˆçš„å†…å®¹:', text);
            } catch (error) {
                output.className = 'output error';
                output.textContent = 'é”™è¯¯: ' + error.message + '\n\n' + error.stack;
                console.error('ç”Ÿæˆå†…å®¹é”™è¯¯:', error);
            }
        };

        // æµå¼ç”Ÿæˆå†…å®¹ - æŒ‚è½½åˆ° window
        window.generateContentStream = async function() {
            if (!ai) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }

            const prompt = document.getElementById('streamPrompt').value.trim();
            const modelSelect = document.getElementById('streamModelSelect');
            const modelInput = document.getElementById('streamModel');
            
            // è·å–é€‰ä¸­çš„æ¨¡å‹åç§°
            let modelName = '';
            if (modelSelect.value === 'custom') {
                // è‡ªå®šä¹‰è¾“å…¥æ¨¡å¼
                modelName = modelInput.value.trim();
            } else if (modelSelect.value) {
                // ä»ä¸‹æ‹‰åˆ—è¡¨é€‰æ‹©
                modelName = modelSelect.value;
            } else {
                // å¦‚æœä¸‹æ‹‰åˆ—è¡¨ä¸ºç©ºï¼Œæ£€æŸ¥è‡ªå®šä¹‰è¾“å…¥æ¡†
                modelName = modelInput.value.trim();
            }

            if (!prompt) {
                alert('è¯·è¾“å…¥æç¤ºè¯');
                return;
            }

            const output = document.getElementById('streamOutput');
            output.style.display = 'block';
            output.className = 'output loading';
            output.textContent = 'æ­£åœ¨æµå¼ç”Ÿæˆå†…å®¹...\n\n';

            try {
                // å¦‚æœæ²¡æœ‰é€‰æ‹©æ¨¡å‹ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å‹
                const finalModelName = modelName || 'google/gemini-2.5-flash';
                
                const stream = await ai.models.generateContentStream({
                    model: finalModelName,
                    contents: prompt
                });

                // æ¸…ç©ºè¾“å‡ºå¹¶æ˜¾ç¤ºæ¨¡å‹ä¿¡æ¯
                output.className = 'output';
                output.textContent = `ä½¿ç”¨çš„æ¨¡å‹: ${finalModelName}\n\nç”Ÿæˆçš„å†…å®¹:\n`;

                // æµå¼å¤„ç†å“åº”
                for await (const chunk of stream) {
                    if (chunk.text) {
                        // è¿½åŠ æ–‡æœ¬å†…å®¹
                        const currentText = output.textContent;
                        output.textContent = currentText + chunk.text;
                        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                        output.scrollTop = output.scrollHeight;
                    }
                }

                // å®Œæˆåæ ‡è®°ä¸ºæˆåŠŸ
                output.className = 'output success';
                console.log('æµå¼ç”Ÿæˆå®Œæˆ');
            } catch (error) {
                output.className = 'output error';
                output.textContent = 'é”™è¯¯: ' + error.message + '\n\n' + error.stack;
                console.error('æµå¼ç”Ÿæˆå†…å®¹é”™è¯¯:', error);
            }
        };

        // å‡½æ•°è°ƒç”¨æµ‹è¯• - æŒ‚è½½åˆ° window
        window.testFunctionCalling = async function() {
            if (!ai) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }

            const prompt = document.getElementById('functionCallPrompt').value.trim();
            const modelSelect = document.getElementById('functionCallModelSelect');
            const modelInput = document.getElementById('functionCallModel');
            
            // è·å–é€‰ä¸­çš„æ¨¡å‹åç§°
            let modelName = '';
            if (modelSelect.value === 'custom') {
                // è‡ªå®šä¹‰è¾“å…¥æ¨¡å¼
                modelName = modelInput.value.trim();
            } else if (modelSelect.value) {
                // ä»ä¸‹æ‹‰åˆ—è¡¨é€‰æ‹©
                modelName = modelSelect.value;
            } else {
                // å¦‚æœä¸‹æ‹‰åˆ—è¡¨ä¸ºç©ºï¼Œæ£€æŸ¥è‡ªå®šä¹‰è¾“å…¥æ¡†
                modelName = modelInput.value.trim();
            }

            if (!prompt) {
                alert('è¯·è¾“å…¥æç¤ºè¯');
                return;
            }

            const output = document.getElementById('functionCallOutput');
            output.style.display = 'block';
            output.className = 'output loading';
            output.textContent = 'æ­£åœ¨æµ‹è¯•å‡½æ•°è°ƒç”¨...';

            try {
                // å¦‚æœæ²¡æœ‰é€‰æ‹©æ¨¡å‹ï¼Œä½¿ç”¨é»˜è®¤æ¨¡å‹
                const finalModelName = modelName || 'google/gemini-2.5-flash';
                
                // å®šä¹‰æ§åˆ¶ç¯å…‰çš„å‡½æ•°å£°æ˜
                const controlLightDeclaration = {
                    name: 'controlLight',
                    parametersJsonSchema: {
                        type: 'object',
                        properties: {
                            brightness: { type: 'number' },
                            colorTemperature: { type: 'string' },
                        },
                        required: ['brightness', 'colorTemperature'],
                    },
                };

                const response = await ai.models.generateContent({
                    model: finalModelName,
                    contents: prompt,
                    config: {
                        toolConfig: {
                            functionCallingConfig: {
                                mode: FunctionCallingConfigMode.ANY,
                                allowedFunctionNames: ['controlLight'],
                            }
                        },
                        tools: [{ functionDeclarations: [controlLightDeclaration] }]
                    }
                });

                output.className = 'output success';
                const functionCalls = response.functionCalls || [];
                
                if (functionCalls.length > 0) {
                    output.textContent = `ä½¿ç”¨çš„æ¨¡å‹: ${finalModelName}\n\nå‡½æ•°è°ƒç”¨ç»“æœ:\n${JSON.stringify(functionCalls, null, 2)}`;
                } else {
                    output.textContent = `ä½¿ç”¨çš„æ¨¡å‹: ${finalModelName}\n\næœªæ£€æµ‹åˆ°å‡½æ•°è°ƒç”¨ã€‚\n\nå“åº”æ–‡æœ¬: ${response.text || 'æ— æ–‡æœ¬å“åº”'}`;
                }
                
                console.log('å‡½æ•°è°ƒç”¨ç»“æœ:', functionCalls);
            } catch (error) {
                output.className = 'output error';
                output.textContent = 'é”™è¯¯: ' + error.message + '\n\n' + error.stack;
                console.error('å‡½æ•°è°ƒç”¨æµ‹è¯•é”™è¯¯:', error);
            }
        };

        // æ›´æ–°æ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨
        function updateModelSelect() {
            if (!ai) return;
            
            try {
                const models = ai.getSupportedModels();
                
                // æ›´æ–°ç”Ÿæˆå†…å®¹æµ‹è¯•éƒ¨åˆ†çš„æ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨
                const modelSelect = document.getElementById('modelSelect');
                if (modelSelect) {
                    const currentValue = modelSelect.value;
                    while (modelSelect.options.length > 2) {
                        modelSelect.remove(2);
                    }
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });
                    if (currentValue && Array.from(modelSelect.options).some(opt => opt.value === currentValue)) {
                        modelSelect.value = currentValue;
                    }
                }
                
                // æ›´æ–°æµå¼å“åº”æµ‹è¯•éƒ¨åˆ†çš„æ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨
                const streamModelSelect = document.getElementById('streamModelSelect');
                if (streamModelSelect) {
                    const currentStreamValue = streamModelSelect.value;
                    while (streamModelSelect.options.length > 2) {
                        streamModelSelect.remove(2);
                    }
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        streamModelSelect.appendChild(option);
                    });
                    if (currentStreamValue && Array.from(streamModelSelect.options).some(opt => opt.value === currentStreamValue)) {
                        streamModelSelect.value = currentStreamValue;
                    }
                }
                
                // æ›´æ–°å‡½æ•°è°ƒç”¨æµ‹è¯•éƒ¨åˆ†çš„æ¨¡å‹ä¸‹æ‹‰åˆ—è¡¨
                const functionCallModelSelect = document.getElementById('functionCallModelSelect');
                if (functionCallModelSelect) {
                    const currentFunctionCallValue = functionCallModelSelect.value;
                    while (functionCallModelSelect.options.length > 2) {
                        functionCallModelSelect.remove(2);
                    }
                    models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        functionCallModelSelect.appendChild(option);
                    });
                    if (currentFunctionCallValue && Array.from(functionCallModelSelect.options).some(opt => opt.value === currentFunctionCallValue)) {
                        functionCallModelSelect.value = currentFunctionCallValue;
                    }
                }
            } catch (error) {
                console.error('æ›´æ–°æ¨¡å‹åˆ—è¡¨é”™è¯¯:', error);
            }
        }

        // å¤„ç†æ¨¡å‹é€‰æ‹©å˜åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç”Ÿæˆå†…å®¹æµ‹è¯•éƒ¨åˆ†çš„æ¨¡å‹é€‰æ‹©å™¨
            const modelSelect = document.getElementById('modelSelect');
            const modelInput = document.getElementById('model');
            
            if (modelSelect && modelInput) {
                modelSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        modelInput.style.display = 'block';
                        modelInput.focus();
                    } else if (this.value) {
                        modelInput.style.display = 'none';
                        modelInput.value = '';
                    } else {
                        modelInput.style.display = 'none';
                    }
                });
            }
            
            // æµå¼å“åº”æµ‹è¯•éƒ¨åˆ†çš„æ¨¡å‹é€‰æ‹©å™¨
            const streamModelSelect = document.getElementById('streamModelSelect');
            const streamModelInput = document.getElementById('streamModel');
            
            if (streamModelSelect && streamModelInput) {
                streamModelSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        streamModelInput.style.display = 'block';
                        streamModelInput.focus();
                    } else if (this.value) {
                        streamModelInput.style.display = 'none';
                        streamModelInput.value = '';
                    } else {
                        streamModelInput.style.display = 'none';
                    }
                });
            }
            
            // å‡½æ•°è°ƒç”¨æµ‹è¯•éƒ¨åˆ†çš„æ¨¡å‹é€‰æ‹©å™¨
            const functionCallModelSelect = document.getElementById('functionCallModelSelect');
            const functionCallModelInput = document.getElementById('functionCallModel');
            
            if (functionCallModelSelect && functionCallModelInput) {
                functionCallModelSelect.addEventListener('change', function() {
                    if (this.value === 'custom') {
                        functionCallModelInput.style.display = 'block';
                        functionCallModelInput.focus();
                    } else if (this.value) {
                        functionCallModelInput.style.display = 'none';
                        functionCallModelInput.value = '';
                    } else {
                        functionCallModelInput.style.display = 'none';
                    }
                });
            }
        });

        // æ£€æŸ¥ BaseURL - æŒ‚è½½åˆ° window
        window.checkBaseUrl = function() {
            if (!ai) {
                alert('è¯·å…ˆé…ç½® API Key');
                return;
            }

            const output = document.getElementById('baseUrlOutput');
            output.style.display = 'block';

            try {
                // é€šè¿‡è®¿é—® protected apiClient æ¥è·å– baseURL
                const apiClient = ai['apiClient'];
                const baseUrl = apiClient ? apiClient.getBaseUrl() : 'æ— æ³•è®¿é—®';
                
                output.className = 'output success';
                output.textContent = `BaseURL: ${baseUrl}\n\né¢„æœŸå€¼: https://router.shengsuanyun.com/api/\n\n${baseUrl === 'https://router.shengsuanyun.com/api/' ? 'âœ“ BaseURL é…ç½®æ­£ç¡®ï¼' : 'âš  BaseURL å¯èƒ½æœªæ­£ç¡®è®¾ç½®'}`;
                console.log('BaseURL:', baseUrl);
            } catch (error) {
                output.className = 'output error';
                output.textContent = 'é”™è¯¯: ' + error.message + '\n\næ³¨æ„: è¿™å¯èƒ½æ˜¯ç”±äºæ— æ³•è®¿é—® protected æˆå‘˜å¯¼è‡´çš„ã€‚';
                console.error('æ£€æŸ¥ BaseURL é”™è¯¯:', error);
            }
        };

        // æ˜¾ç¤ºçŠ¶æ€
        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = 'status ' + type;
            setTimeout(() => {
                element.textContent = '';
                element.className = '';
            }, 3000);
        }

        // ä» localStorage åŠ è½½ä¿å­˜çš„ API Key
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                const savedApiKey = localStorage.getItem('genai_api_key');
                if (savedApiKey) {
                    document.getElementById('apiKey').value = savedApiKey;
                }
            });
        } else {
            // DOM å·²ç»åŠ è½½å®Œæˆ
            const savedApiKey = localStorage.getItem('genai_api_key');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }
        }
    </script>
    </body>
</html>
